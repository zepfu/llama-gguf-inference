---
name: CI

on:
  push:
    branches: ["main"]
    paths:
      - 'scripts/**'
      - 'Dockerfile'
      - '.github/workflows/ci.yml'
      - 'pyproject.toml'
      - '.pre-commit-config.yaml'
      - 'Makefile'
      - 'repo.mk'
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  # ===========================================================================
  # Organization standards (reusable workflows from repo-standards)
  # ===========================================================================

  pre-commit:
    name: Pre-commit Hooks
    uses: zepfu/repo-standards/.github/workflows/reusable-pre-commit.yml@main
    with:
      python-version: '3.11'

  python-standards:
    name: Python Standards
    uses: zepfu/repo-standards/.github/workflows/reusable-python-ci.yml@main
    with:
      python-version: '3.11'

  shell-standards:
    name: Shell Standards
    uses: zepfu/repo-standards/.github/workflows/reusable-shell-ci.yml@main
    with:
      severity: 'error'
      shellcheck-version: 'v0.9.0'

  quality-checks:
    name: Quality Checks
    uses: zepfu/repo-standards/.github/workflows/reusable-quality-checks.yml@main
    with:
      python-version: '3.11'

  config-validation:
    name: Config Standards
    uses: zepfu/repo-standards/.github/workflows/reusable-config-validation.yml@main

  makefile-validation:
    name: Makefile Standards
    uses: zepfu/repo-standards/.github/workflows/reusable-makefile-ci.yml@main

  # ===========================================================================
  # Project validation
  # ===========================================================================

  validate-project:
    name: Validate Project Files
    runs-on: ubuntu-latest
    needs: [config-validation]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required files
        run: |
          REQUIRED_FILES=(
            "scripts/gateway.py"
            "scripts/auth.py"
            "scripts/start.sh"
            "Dockerfile"
          )

          MISSING=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING+=("$file")
            fi
          done

          if [ ${#MISSING[@]} -ne 0 ]; then
            echo "ERROR: Required files missing:"
            printf '  - %s\n' "${MISSING[@]}"
            exit 1
          fi

          echo "SUCCESS: All required files present"

      - name: Validate Docker configuration
        run: |
          if ! grep -q "EXPOSE 8000" Dockerfile; then
            echo "ERROR: Dockerfile must expose port 8000"
            exit 1
          fi

          echo "SUCCESS: Docker configuration valid"

  # ===========================================================================
  # Docker build + integration tests
  # ===========================================================================

  docker-build:
    name: Docker Build
    uses: zepfu/repo-standards/.github/workflows/reusable-docker-build.yml@main
    needs: [python-standards, shell-standards, quality-checks, validate-project]
    with:
      platforms: 'linux/amd64'
      push: false

  integration-test:
    name: Integration Test (Mock Backend)
    runs-on: ubuntu-latest
    needs: [docker-build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: llama-gguf-inference:test
          load: true
          cache-from: type=gha

      - name: Create test environment
        run: |
          mkdir -p /tmp/test-data/models
          mkdir -p /tmp/test-data/logs
          echo "testing:sk-test-1234567890abcdef" > /tmp/test-data/api_keys.txt
          echo "loadtest:sk-load-abcdef1234567890" >> /tmp/test-data/api_keys.txt
          touch /tmp/test-data/models/test-model.gguf

      - name: Start container with mock backend
        run: |
          docker run -d \
            --name llama-test \
            -v /tmp/test-data:/data \
            -e MODEL_NAME=test-model.gguf \
            -e AUTH_ENABLED=true \
            -e AUTH_KEYS_FILE=/data/api_keys.txt \
            -e MOCK_BACKEND=true \
            -p 8000:8000 \
            llama-gguf-inference:test

      - name: Test health endpoints
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8000/ping; then
              echo "Container ready after ${i}s"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "Container failed to start within 30s"
              docker logs llama-test
              exit 1
            fi
            sleep 1
          done
          curl -f http://localhost:8000/health || exit 1

      - name: Test auth rejection
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            http://localhost:8000/v1/chat/completions \
            -H "Content-Type: application/json" \
            -d '{"model":"test","messages":[{"role":"user","content":"test"}]}')
          [ "$STATUS" = "401" ] || exit 1

      - name: Test auth acceptance
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer sk-test-1234567890abcdef" \
            http://localhost:8000/v1/chat/completions \
            -H "Content-Type: application/json" \
            -d '{"model":"test","messages":[{"role":"user","content":"test"}]}')
          [ "$STATUS" = "200" ] || [ "$STATUS" = "502" ] || exit 1

      - name: Stop container
        if: always()
        run: |
          docker logs llama-test || true
          docker stop llama-test || true
          docker rm llama-test || true
