name: Code Quality

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8
          
      - name: Run Black (Python formatter)
        run: |
          black --check --line-length=100 scripts/*.py || true
          
      - name: Run isort (Import sorter)
        run: |
          isort --check --profile=black --line-length=100 scripts/*.py || true
          
      - name: Run Flake8 (Python linter)
        run: |
          flake8 scripts/*.py \
            --max-line-length=100 \
            --extend-ignore=E203,W503 \
            --max-complexity=15 || true
  
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: './scripts'
          severity: warning
          check_together: 'yes'

  validate-scripts:
    name: Validate Script Syntax
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Validate Python scripts compile
        run: |
          python -m py_compile scripts/gateway.py
          python -m py_compile scripts/auth.py
          python -m py_compile scripts/health_server.py
          
      - name: Validate Bash scripts syntax
        run: |
          bash -n scripts/start.sh
          bash -n scripts/tests/test_auth.sh
          bash -n scripts/tests/test_health.sh

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [lint, shellcheck, validate-scripts]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: llama-gguf-inference:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: Inspect image
        run: docker images llama-gguf-inference:test
